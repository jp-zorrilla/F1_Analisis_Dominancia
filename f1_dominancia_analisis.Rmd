---
title: "Dominancia y Competitividad Hist√≥rica en la F√≥rmula 1 (1950-2020)"
author: "Zorrilla Juan Pedro"
date: "`r format(Sys.Date(), '%d de %B, %Y')`"
output: html_document
---

# üèéÔ∏è Estudio de Caso: Dominancia y Competitividad Hist√≥rica en la F√≥rmula 1 (1950-2020)
## Resumen 
Este proyecto utiliza el an√°lisis de datos para cuantificar la **evoluci√≥n de la competitividad** en el deporte de la F√≥rmula 1 a lo largo de 70 a√±os. Se construyeron dos m√©tricas clave: el Margen de Victoria Promedio y la Diversidad de Equipos Ganadores Anuales. El hallazgo principal es que la F1 moderna es intensa (carreras con m√°rgenes m√≠nimos) pero concentrada (poca diversidad de equipos ganadores), contrastando con la era fundacional (1950s), que era amplia pero desigual.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
```

üíæ**Metodolog√≠a y Herramientas**  
Herramientas: Lenguaje R (RStudio) y la librer√≠a tidyverse (dplyr, ggplot2).

Fuente de Datos: Dataset hist√≥rico de F1 (Kaggle / Ergast API).

```{r setup, include=FALSE}
```{r}
## Etapa 1 Cargar y almacenar los datos

# 1.1. Cargar datos
results_df <- read_csv("results.csv")
races_df <- read_csv("races.csv")
constructors_df <-read_csv("constructors.csv")

# 1.2. Seleccionar y renombrar las columnas clave
# Objetivo evitar confusiones de nombres (ej: nombres de columnas repetidas)
races_clean <- races_df%>% 
  select(raceId, year, name) %>% 
  rename(race_name = name)

constructors_clean <- constructors_df %>% 
  rename(constructor_name = name)

# 1.3. Fusionar (JOIN)  los resultados con la informaci√≥n de carreras y equipos
# left_join para mantener todos los resultados y a√±adir la informaci√≥n relacionada
data_f1_completa <- results_df %>%
  # Unir con la informaci√≥n de carrea (por raceId)
  left_join(races_clean, by = "raceId") %>% 
  #Unir con los nombres de los constructores (por constructorId)
  left_join(constructors_clean, by = "constructorId")

# 1.4. Exploraci√≥n r√°pida del dataset fusionado
print("Estructura de la tabla fusionada (data_f1_completa):")
print(paste("N√∫mero total de observaciones:", nrow(data_f1_completa)))
head(data_f1_completa)
```


```{r}
## 2. Limpieza y c√°lculo del Margen de Victoria
margen_victoria_df <- data_f1_completa %>%
  # 1. Agrupar por carrera
  group_by(raceId, year, constructor_name, race_name) %>%
  
  # 2. Obtener el margen:
  mutate(
    # Obtener el valor de 'time' del P2. Esto solo funciona si el P2 termin√≥ en la misma vuelta.
    time_gap_raw = time[position == 2][1],
    winning_constructor = constructor_name[position == 1][1]
  ) %>%
  
  # 3. Limpieza: Extraer solo el n√∫mero del gap (ej. de "+1.500s" a 1.500)
  # Usamos str_replace para limpiar el '+' y la 's'.
  # Usamos str_remove para eliminar '+', y str_remove para eliminar 's'.
  mutate(
    Margin_s = as.numeric(str_remove(str_remove(time_gap_raw, "\\+"), "s"))
  ) %>%
  
  # 4. Filtrar solo las filas con un margen v√°lido (P2 termin√≥ en la misma vuelta)
  # El margen debe ser positivo, no NA, y menor a 600 segundos (10 minutos)
  filter(!is.na(Margin_s) & Margin_s > 0 & Margin_s < 600) %>% 
  
  # 5. Seleccionar las m√©tricas claves del resultado de la carrera
  ungroup() %>%
  select(year, winning_constructor, race_name, Margin_s) %>%
  
  # 6. Usamos race_name y year para identificar la fila √∫nica de la carrera
  distinct(race_name, year, .keep_all = TRUE)

print("--- RESULTADOS DE LA ETAPA 2 SOLUCI√ìN FINAL CON 'time' ---")
print(paste("N√∫mero de carreras con margen de victoria calculado:", nrow(margen_victoria_df)))
head(margen_victoria_df)
```
Desaf√≠os Resueltos (Ingenier√≠a de Datos)
El principal desaf√≠o fue que la columna est√°ndar de tiempo para el P2 (milliseconds) a menudo conten√≠a valores gigantescos (tiempo total de carrera) o \N, no el margen de victoria.

Soluci√≥n: Se implement√≥ una l√≥gica de limpieza utilizando expresiones regulares sobre la columna de texto time para extraer el margen de victoria en segundos, descartando las carreras en las que el P2 termin√≥ a m√°s de una vuelta.

R

# L√≥gica para extraer el margen (el gap) de la columna de texto 'time'
Margin_s = as.numeric(str_remove(str_remove(time_gap_raw, "\\+"), "s"))


3. An√°lisis de Datos y Limpieza (M√©tricas Clave) üß™
Margen de Victoria Promedio (Intensidad): Mide el margen de tiempo promedio entre el P1 y el P2 en carreras ganadas (Margen bajo = Alta competitividad).

```{r}
  # Un margen M√ÅS BAJO indica una carrera CERRADA. Un margen M√ÅS ALTO indica DOMINANCIA
  
  # 1. Creaci√≥n del dataframe Margen Limpio
margen_limpio_df <- margen_victoria_df %>%
  select(year, winning_constructor, Margin_s)

  # 2. Agregamos el Rendimiento Anual (Dominancia Promedio)
dominancia_anual <- margen_limpio_df %>%
  group_by(year, winning_constructor) %>%
  summarise(
    Avg_Margin_s = mean(Margin_s, na.rm = TRUE),
    Total_Wins = n(),
    .groups = 'drop' 
  ) %>%
  
  # 3. Filtramos por un m√≠nimo de 3 victorias para un an√°lisis significativo
  filter(Total_Wins >= 3) 

  # 4. Identificamos a los 5 constructores m√°s ganadores hist√≥ricamente para el an√°lisis
top_constructors <- margen_limpio_df %>%
  count(winning_constructor, sort = TRUE) %>%
  slice_head(n = 5) %>%
  pull(winning_constructor)

  # 5. Filtramos los datos anuales para incluir solo esos equipos TOP
dominancia_top_anual <- dominancia_anual %>%
  filter(winning_constructor %in% top_constructors)

  # 6. Identificamos el punto de m√°xima dominancia para etiquetar (La tabla que da el pico)
pico_dominancia <- dominancia_top_anual %>%
  filter(Avg_Margin_s == max(Avg_Margin_s, na.rm = TRUE))

print("Tablas de agregaci√≥n y pico creadas. Generando gr√°fico...")

```

Diversidad de Equipos Ganadores (Frecuencia): Mide el n√∫mero de constructores √∫nicos que ganaron al menos una carrera en una temporada.

```{r}
## 5. Contar Ganadores √önicos por Temporada
# Usamos la tabla completa (data_f1_completa) y nos enfocamos solo en la posici√≥n 1.
ganadores_absolutos_df <- data_f1_completa %>%
  
  # 1. Nos quedamos solo con los ganadores de la carrera
  filter(position == 1) %>%
  
  # 2. Excluimos filas donde el nombre del constructor no fue mapeado (NA)
  filter(!is.na(constructor_name)) %>%
  
  # 3. Agrupamos solo por el a√±o
  group_by(year) %>%
  
  # 4. Contamos el n√∫mero de constructores √∫nicos que ganaron ese a√±o
  summarise(
    Unique_Winners_Absoluto = n_distinct(constructor_name),
    .groups = 'drop' 
  )

print("--- Diversidad de Ganadores por A√±o (Conteo Absoluto) ---")
head(ganadores_absolutos_df)
```


    
4. Visualizaciones y Resultados Clave üìä
4.1. Gr√°fico A: Evoluci√≥n del Margen de Victoria (Dominancia)
Hallazgo Clave: El per√≠odo de mayor dominancia ocurri√≥ en 1950, con un margen de victoria promedio de 49.84 segundos, demostrando la disparidad inicial.

```{r}
# Definimos la ruta y el nombre del archivo de salida
png("dominancia_f1_margen.png", width = 10, height = 6, units = "in", res = 300)

ggplot(dominancia_top_anual, aes(x = year, y = Avg_Margin_s, color = winning_constructor)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  labs(
    title = "Evoluci√≥n del Margen de Victoria Promedio (Dominancia) de los Top 5 Equipos",
    subtitle = "Margen de victoria promedio (en segundos) en las carreras ganadas (M√≠nimo 3 victorias/a√±o)",
    x = "A√±o",
    y = "Margen de Victoria Promedio (Segundos)",
    color = "Equipo Ganador"
  ) +
  
  # 1. Invertimos el eje Y: mayor margen (m√°s dominancia) en la parte superior
  scale_y_reverse() + 
  theme_minimal() +
  
  # 2. Etiquetamos el pico m√°ximo de dominancia hist√≥rica (USANDO LA TABLA PRECALCULADA)
  geom_text(data = pico_dominancia,
            aes(label = paste(winning_constructor, "\n", round(Avg_Margin_s, 2), "s"), x = year + 2), 
            vjust = 0, color = "red", fontface = "bold", size = 4) +
  
  # 3. A√±adimos una l√≠nea de ayuda para el margen cero (carreras muy cerradas)
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50")
  # Cerramos el dispositivo gr√°fico para guardar el archivo
dev.off()

```


Tendencia: Las l√≠neas de tendencia en el eje Y (Margen) se mueven constantemente hacia el cero en la era moderna, lo que indica que la F1 es significativamente m√°s competitiva hoy que en sus inicios.

4.2. Gr√°fico B: Evoluci√≥n de la Diversidad de Equipos Ganadores
Hallazgo Clave: La m√°xima diversidad se registr√≥ en 1977, con 7 constructores √∫nicos ganando carreras, reflejando una parrilla muy abierta.

```{r}
## 6. Gr√°fico de Estabalidad absoluta
# Define la ruta y el nombre del archivo de salida
png("diversidad_f1_ganadores.png", width = 10, height = 6, units = "in", res = 300)

ggplot(ganadores_absolutos_df, aes(x = year, y = Unique_Winners_Absoluto)) +
  geom_line(color = "darkblue", linewidth = 1) +
  geom_point(color = "darkblue", size = 2) +
  # 1. A√±adimos etiquetas a los picos (m√°xima diversidad)
  geom_text(data = ganadores_absolutos_df %>% filter(Unique_Winners_Absoluto == max(Unique_Winners_Absoluto)),
            aes(label = Unique_Winners_Absoluto), vjust = -1, color = "red", fontface = "bold") +
  # 2. A√±adimos etiquetas a los valles (m√≠nima diversidad)
  geom_text(data = ganadores_absolutos_df %>% filter(Unique_Winners_Absoluto == min(Unique_Winners_Absoluto)),
            aes(label = Unique_Winners_Absoluto), vjust = 2, color = "red", fontface = "bold") +
  labs(
    title = "Evoluci√≥n de la Diversidad de Equipos Ganadores por Temporada (Absoluto)",
    subtitle = "N√∫mero de constructores √∫nicos que ganaron al menos una carrera por a√±o",
    x = "A√±o",
    y = "N√∫mero de Ganadores √önicos"
  ) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 5)) +
  theme_minimal()

# Cerramos el dispositivo gr√°fico para guardar el archivo
dev.off()
```


Tendencia: La tendencia moderna muestra una concentraci√≥n de las victorias. El campo se reduce a un pu√±ado de equipos de √©lite, evidenciando una menor estabilidad.

5. Conclusiones e Implicaciones
El an√°lisis combinado de ambas m√©tricas revela la naturaleza dual de la F1 moderna:

Competitividad Extrema (Intensidad Alta): La convergencia tecnol√≥gica ha hecho que las carreras se ganen por m√°rgenes m√≠nimos (ej. menos de 10 segundos en promedio), lo que demuestra la alta competencia t√©cnica.

Baja Estabilidad (Concentraci√≥n de √âxito): A pesar de la alta intensidad, la diversidad de ganadores es baja (rara vez supera los 4 o 5 equipos por a√±o). Esto sugiere que solo un pu√±ado de equipos de √©lite tiene la capacidad de luchar por esas victorias estrechas.

El proyecto concluye que la F1 ha evolucionado desde ser desigual y diversa a ser intensa y concentrada.



